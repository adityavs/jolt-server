<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: modules/LiveReload.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: modules/LiveReload.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* imports */
import fs from "fs";
import os from "os";
import path from "path";
import INJECTED_CODE from "../constants/InjectedCode";

/**
 * Enables LiveReload Functionality
 * @class
 * @private
 */
export class LiveReload {

    /**
     * Enables live reloading.
     * @param {WebServer} server - The web server to connect to.
     */
    static enable(server) {
        LiveReload.watch(server._root, (event, filename) => {
            if (filename) {
                if (LiveReload._fsWait) return;

                LiveReload._fsWait = setTimeout(() => {
                    LiveReload._fsWait = false;
                }, 100);

                LiveReload.reload();
            }
        });
    }

    /**
     * Register the connection with the live reloader.
     * @param {http.ServerResponse} res - The response to regiser.
     */
    static register(res) {
        res.writeHead(200, {
            "Content-type": "text/event-stream",
            "Cache-Control": "no-cache",
            "Connection": "keep-alive"
        });

        LiveReload._connections.push(res);
    }

    /** Tell the connected browsers to reload */
    static reload() {
        for (let connection of LiveReload._connections) {
            connection.write("data: reload\n\n");
            LiveReload._connections.slice(LiveReload._connections.indexOf(connection), 1);
        }
    }

    /**
     * Injects the code into the requested html file.
     * @param {string} pathname - The file path.
     * @param {http.ServerResponse} res - The response object.
     */
    static inject(pathname, res) {
        let injectTag = null;

        fs.readFile(pathname, "utf8", (error, data) => {
            if (error) {
                if (error.errno == -2) {
                    res.statusCode = 404;
                    res.end(`ERROR 404: ${error.path} was not found.`);
                } else {
                    res.statusCode = 500;
                    res.end(error.message);
                }
                return;
            }

            const match = new RegExp("&lt;/body>", "i").exec(data);
            if (match) {
                injectTag = match[0];
            }

            if (injectTag) {
                res.setHeader("Content-type", "text/html");
                res.end(data.replace(injectTag, INJECTED_CODE + injectTag));
            }
        });
    }

    /**
     * Watches a file or directory for changes.
     * @param {string} target - The file or directory to watch.
     * @param {function} callback - The callback to use.
     */
    static watch(target, callback) {
        if (!["darwin", "win32"].includes(os.platform())) {
            if (fs.statSync(target).isDirectory()) {
                fs.watch(target, callback);
                fs.readdirSync(target).forEach((entry) => {
                    LiveReload.watch(`${path}/${entry}`, callback);
                });
            }
        } else {
            fs.watch(target, { recursive: true }, callback);
        }
    }
}

LiveReload._connections = [];
LiveReload._fsWait = false;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Application.html">Application</a></li></ul><h3>Global</h3><ul><li><a href="global.html#serve">serve</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Wed Apr 29 2020 19:35:16 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
